# Задание 1  
1. Возьмите код:
из ДЗ к лекции №04
из демо к лекции №04.
2. Проверьте код с помощью tflint и checkov. Вам не нужно инициализировать этот проект.
3. Перечислите какие типы ошибок обнаружены в проекте (без дублей).

TFLint:
1. Module source uses a default branch as ref (main)
2. Missing version constraint for provider
3. Variable is declared but not used  

Checkov:
1. CKV_YC_11: "Ensure security group is assigned to network interface."
2. CKV_YC_2: "Ensure compute instance does not have public IP."
3. CKV_TF_1: "Ensure Terraform module sources use a commit hash"

# Задание 2  
1. Возьмите ваш GitHub репозиторий с выполненным ДЗ №4 в ветке 'terraform-04' и сделайте из него ветку 'terraform-05'
2. Повторите демонстрацию лекции: настройте YDB, S3 bucket, yandex service account, права доступа и мигрируйте State проекта в S3 с блокировками. Предоставьте скриншоты процесса в качестве ответа.
3. Закомитьте в ветку 'terraform-05' все изменения.
4. Откройте в проекте terraform console, а в другом окне из этой же директории попробуйте запустить terraform apply.
5. Пришлите ответ об ошибке доступа к State.
6. Принудительно разблокируйте State. Пришлите команду и вывод.

```terraform
backend "s3" {
     endpoint = "storage.yandexcloud.net"
     bucket = "netology-tfstate-hw05"
     region = "ru-central1"
     key = "terraform.tfstate"

     skip_region_validation = true
     skip_credentials_validation = true

     dynamodb_endpoint = "https://docapi.serverless.yandexcloud.net/ru-central1/b1g7scnf5uvlbrtgv0aj/etnth7e7g92dkavtbltl"
     dynamodb_table = "netology-tfstate"
   }
```
<img width="1146" alt="image" src="https://github.com/nehardcore/terraform/assets/97674120/fab701f0-c9ab-468b-91a9-d3333cced79e">

<img width="957" alt="image" src="https://github.com/nehardcore/terraform/assets/97674120/7e79ef50-2ec1-43b6-bc9d-fcbc367a4d73">

<img width="872" alt="image" src="https://github.com/nehardcore/terraform/assets/97674120/b1360db0-9818-4c01-83db-1cb925c20509">

<img width="539" alt="image" src="https://github.com/nehardcore/terraform/assets/97674120/d3ae7d66-d43c-42b0-94f6-7be2d8571f07">

<img width="633" alt="image" src="https://github.com/nehardcore/terraform/assets/97674120/1be753ad-c8e0-44a9-9c75-c732dd02b147">

# Задание 3

1. Сделайте в GitHub из ветки 'terraform-05' новую ветку 'terraform-hotfix'.
2. Проверье код с помощью tflint и checkov, исправьте все предупреждения и ошибки в 'terraform-hotfix', сделайте комит.
3. Откройте новый pull request 'terraform-hotfix' --> 'terraform-05'.
4. Вставьте в комментарий PR результат анализа tflint и checkov, план изменений инфраструктуры из вывода команды terraform plan.
5. Пришлите ссылку на PR для ревью(вливать код в 'terraform-05' не нужно).

> Исправил все локальные ошибки, типа неиспользованных переменных и отстутствие версии для провайдера. Остались ошибки в удаленном модуле, но это уже не мне исправлять, как я понимаю.

> PR: https://github.com/nehardcore/terraform/pull/1

# Задание 4

Напишите переменные с валидацией и протестируйте их, заполнив default верными и неверными значениями. Предоставьте скриншоты проверок из terraform console.
- type=string, description="ip-адрес", проверка что значение переменной содержит верный IP-адрес с помощью функций cidrhost() или regex(). Тесты: "192.168.0.1" и "1920.1680.0.1"
- type=list(string), description="список ip-адресов", проверка что все адреса верны. Тесты: ["192.168.0.1", "1.1.1.1", "127.0.0.1"] и ["192.168.0.1", "1.1.1.1", "1270.0.0.1"]
```terraform
variable "vm_local_ip" {
  type = string
  default = "10.0.1.4"
  validation {
    condition     = can(cidrnetmask("${var.vm_local_ip}/32"))
    error_message = "Must be a valid IPv4 CIDR block address."
  }
}

variable "vm_local_ips" {
  type = list(string)
  default = ["10.0.1.4", "192.168.0.4", "127.0.0.1"]
  validation {
    condition = alltrue([
      for a in var.vm_local_ips : can(cidrnetmask("${a}/32"))
    ])
    error_message = "All elements must be valid IPv4 CIDR block addresses."
  }
}
```
<img width="175" alt="image" src="https://github.com/nehardcore/terraform/assets/97674120/9f897665-cdd9-4cac-9804-694d4c290dca">

```terraform
variable "vm_local_ip" {
  type = string
  default = "10.0.1.4111"
  validation {
    condition     = can(cidrnetmask("${var.vm_local_ip}/32"))
    error_message = "Must be a valid IPv4 CIDR block address."
  }
}

variable "vm_local_ips" {
  type = list(string)
  default = ["10.0.1.4", "192.168.0.4", "1270.0.0.1"]
  validation {
    condition = alltrue([
      for a in var.vm_local_ips : can(cidrnetmask("${a}/32"))
    ])
    error_message = "All elements must be valid IPv4 CIDR block addresses."
  }
}
```
<img width="496" alt="image" src="https://github.com/nehardcore/terraform/assets/97674120/28632f08-3390-49e1-b412-1042d5faa1e1">

